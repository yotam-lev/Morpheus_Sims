<?xml version='1.0' encoding='UTF-8'?>
<MorpheusModel version="4">
    <Description>
        <Title>Hybrid CPM: Elongated and Round Cells with VEGF</Title>
        <Details>
            Cellular Potts Model with:
            - Elongated cells (proliferate on VEGF contact)
            - Round cells
            - VEGF diffusion and decay
            - Anti-space for increasing static behavior
        </Details>
    </Description>
    <Space>
        <Lattice class="square">
            <Size symbol="size" value="400, 400, 0"/>
            <BoundaryConditions>
                <Condition type="noflux" boundary="x"/>
                <Condition type="noflux" boundary="y"/>
            </BoundaryConditions>
            <Neighborhood>
                <Order>2</Order>
            </Neighborhood>
        </Lattice>
        <SpaceSymbol symbol="space"/>
    </Space>
    <Time>
        <StartTime value="0"/>
        <StopTime value="10000"/>
        <TimeSymbol symbol="time"/>
    </Time>
    <Global>
        <Constant symbol="T" name="Temperature" value="10.0"/>
        <Constant symbol="lambda_volume_elongated" name="Volume constraint" value="4.0"/>
        <Constant symbol="lambda_surface_elongated" name="Surface constraint" value="3.0"/>
        <Constant symbol="vegf_threshold" name="VEGF proliferation threshold" value="0.5"/>
        <Constant symbol="antispace_reduction" name="Anti-space reduction rate" value="0.001"/>
        <Constant symbol="J_ee" name="Elongated-Elongated adhesion" value="5.0"/>
        <Constant symbol="J_rr" value="6.0"/>
        <Constant symbol="J_er" value="5.0"/>
        <Constant symbol="J_em" value="7.0"/>
        <Constant symbol="J_rm" value="10.0"/>
        <Field symbol="vegf" name="VEGF concentration" value="0.0">
            <Diffusion rate="vegf_diff"/>
        </Field>
        <Constant symbol="lambda_chemo_elongated" name="Chemotaxis strength (elongated)" value="50.0"/>
        <Constant symbol="lambda_chemo_round" name="Chemotaxis strength (round)" value="20.0"/>
        <Variable symbol="antispace" value="1.0"/>
        <Variable symbol="T_eff" name="Effective temperature" value="T * antispace"/>
        <System time-step="1.0" time-scaling="1.0" solver="Runge-Kutta [fixed, O(4)]">
            <DiffEqn symbol-ref="antispace">
                <Expression>-antispace_reduction * antispace</Expression>
            </DiffEqn>
        </System>
        <Constant symbol="vegf_diff" value="0.1"/>
        <Constant symbol="vegf_decay" value="0.005"/>
        <Constant symbol="lambda_surface_round" value="1.0"/>
        <Constant symbol="lambda_volume_round" value="15.0"/>
        <System solver="Dormand-Prince [adaptive, O(5)]">
            <DiffEqn symbol-ref="vegf">
                <Expression>-vegf_decay * vegf + 1.0 * ( ((space.x-200)^2 + (space.y-200)^2) &lt; 2500 )</Expression>
            </DiffEqn>
        </System>
    </Global>
    <!-- Elongated Cell Type -->
    <!-- Round Cell Type -->
    <!-- CPM Dynamics -->
    <CPM>
        <Interaction default="0.0">
            <Contact type1="ElongatedCell" type2="Medium" value="J_em"/>
            <Contact type1="RoundCell" type2="Medium" value="J_rm"/>
            <Contact type1="ElongatedCell" type2="RoundCell" value="J_er"/>
            <Contact type1="ElongatedCell" type2="ElongatedCell" value="J_ee"/>
            <Contact type1="RoundCell" type2="RoundCell" value="J_rr"/>
        </Interaction>
        <MonteCarloSampler stepper="edgelist">
            <Neighborhood>
                <Order>optimal</Order>
            </Neighborhood>
            <MCSDuration value="1.0"/>
            <MetropolisKinetics yield="0" temperature="T"/>
        </MonteCarloSampler>
        <ShapeSurface scaling="norm">
            <Neighborhood>
                <Order>optimal</Order>
            </Neighborhood>
        </ShapeSurface>
    </CPM>
    <!-- Anti-space dynamics: decreases over time -->
    <!-- Initial Population -->
    <CellPopulations>
        <Population type="ElongatedCell" size="40">
            <InitRectangle number-of-cells="100" mode="random">
                <Dimensions origin="0.0, 0.0, 0.0" size="300.0, 300.0, 0.0"/>
            </InitRectangle>
        </Population>
        <Population type="RoundCell" size="20">
            <InitRectangle number-of-cells="100" mode="random">
                <Dimensions origin="0.0, 0.0, 0.0" size="299.0, 299.0, 0.0"/>
            </InitRectangle>
        </Population>
    </CellPopulations>
    <!-- VEGF initialization -->
    <!-- Analysis and Visualization -->
    <Analysis>
        <Logger time-step="10">
            <Input>
                <Symbol symbol-ref="time"/>
                <Symbol symbol-ref="antispace"/>
            </Input>
            <Output>
                <TextOutput file-name="simulation.csv"/>
            </Output>
        </Logger>
        <Gnuplotter time-step="50" decorate="true">
            <Plot>
                <Field symbol-ref="vegf"/>
                <Cells max="10" min="0" value="cell.type"/>
            </Plot>
            <Terminal name="png"/>
        </Gnuplotter>
        <ModelGraph format="dot" reduced="false" include-tags="#untagged"/>
    </Analysis>
    <CellTypes>
        <CellType class="biological" name="ElongatedCell">
            <SurfaceConstraint target="50" strength="lambda_surface_elongated" mode="surface"/>
            <!--    <Disabled>
        <Property symbol="target_aspect" name="Target Aspect Ratio" value="3.0"/>
    </Disabled>
-->
            <Property symbol="vegf_contact" name="VEGF Contact Level" value="0.0"/>
            <Property symbol="division_timer" name="Division countdown" value="0.0"/>
            <Chemotaxis saturation="1" strength="lambda_chemo_elongated" field="vegf"/>
            <!--    <Disabled>
        <System time-scaling="1.0" solver="Dormand-Prince [adaptive, O(5)]">
            <DiffEqn symbol-ref="division_timer" internal:disabled="true">
                <Expression internal:disabled="true">vegf</Expression>
                <Expression>if(vegf_contact > vegf_threshold and division_timer == 0, 100, if(division_timer > 0, division_timer - 1, 0))</Expression>
            </DiffEqn>
            <DiffEqn symbol-ref="vegf_contact">
                <Expression>vegf</Expression>
            </DiffEqn>
        </System>
    </Disabled>
-->
            <Event time-step="10.0">
                <Condition history="true">division_timer == 1</Condition>
                <Rule symbol-ref="division_timer">
                    <Expression>0</Expression>
                </Rule>
            </Event>
            <CellDivision division-plane="major">
                <Condition>cell.volume > 90 and vegf_contact > 0.4 and rand_uni(0,1) &lt; 0.005</Condition>
                <Triggers>
                    <!--    <Disabled>
        <Rule symbol-ref="division_timer">
            <Expression>0.0</Expression>
        </Rule>
    </Disabled>
-->
                    <Rule symbol-ref="vegf_contact">
                        <!--    <Disabled>
        <Expression>0.0</Expression>
    </Disabled>
-->
                        <Expression>vegf_contact *0.5</Expression>
                    </Rule>
                </Triggers>
            </CellDivision>
            <Property symbol="display" value="1.0"/>
            <LengthConstraint target="50" strength="5" mode="eccentricity"/>
            <VolumeConstraint target="80" strength="lambda_volume_elongated"/>
            <Mapper time-step="1.0">
                <Input value="vegf"/>
                <Output symbol-ref="vegf_contact" mapping="average"/>
            </Mapper>
        </CellType>
        <CellType class="biological" name="RoundCell">
            <VolumeConstraint target="50" strength="lambda_volume_round"/>
            <SurfaceConstraint target="30" strength="lambda_surface_round" mode="surface"/>
            <Chemotaxis strength="lambda_chemo_round" field="vegf "/>
        </CellType>
        <CellType class="medium" name="Medium"/>
    </CellTypes>
</MorpheusModel>
